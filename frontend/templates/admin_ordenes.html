<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/x-icon" href="/static/img/favicon.png">
    <title>Panel de administración - Órdenes</title>
    <link rel="stylesheet" href="/static/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
</head>
<body>
    {% include "partials/header.html" %}

    <section>
        <div class="container mt-5">
            <h2><i class="fas fa-shopping-cart"></i> Gestión de Órdenes</h2>
            
            <!-- Filtros -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <label class="form-label">Estado</label>
                    <select class="form-select" id="filtroEstado" onchange="filtrarOrdenes()">
                        <option value="">Todos los estados</option>
                        <option value="pendiente">Pendiente</option>
                        <option value="pagado">Pagado</option>
                        <option value="enviado">Enviado</option>
                        <option value="cancelado">Cancelado</option>
                    </select>
                </div>
                <div class="col-md-6">
                    <label class="form-label">Filtros de Fecha</label>
                    <div class="d-flex gap-2 mb-2">
                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="aplicarFiltroFecha(7)">
                            <i class="fas fa-calendar-week"></i> Últimos 7 días
                        </button>
                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="aplicarFiltroFecha(30)">
                            <i class="fas fa-calendar-alt"></i> Últimos 30 días
                        </button>
                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="limpiarFiltroFecha()">
                            <i class="fas fa-times"></i> Limpiar
                        </button>
                    </div>
                    <div class="row g-2">
                        <div class="col-4">
                            <input type="date" class="form-control form-control-sm" id="fechaDesde" placeholder="Desde">
                        </div>
                        <div class="col-4">
                            <input type="date" class="form-control form-control-sm" id="fechaHasta" placeholder="Hasta">
                        </div>
                        <div class="col-4">
                            <button type="button" class="btn btn-primary btn-sm w-100" onclick="aplicarRangoPersonalizado()">
                                <i class="fas fa-search"></i> Aplicar
                            </button>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Buscar Cliente</label>
                    <input type="text" class="form-control" id="buscarCliente" onchange="filtrarOrdenes()" placeholder="Buscar por cliente...">
                </div>
            </div>

            <!-- Estadísticas rápidas -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card bg-warning text-white">
                        <div class="card-body">
                            <h5>Pendientes</h5>
                            <h3>{{ ordenes_stats.pendientes or 0 }}</h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-success text-white">
                        <div class="card-body">
                            <h5>Pagadas</h5>
                            <h3>{{ ordenes_stats.pagadas or 0 }}</h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-info text-white">
                        <div class="card-body">
                            <h5>Enviadas</h5>
                            <h3>{{ ordenes_stats.enviadas or 0 }}</h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-primary text-white">
                        <div class="card-body">
                            <h5>Total Hoy</h5>
                            <h3>${{ "%.2f"|format(ordenes_stats.total_hoy or 0) }}</h3>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tabla de órdenes -->
            <div class="table-responsive">
                <table class="table table-bordered table-hover">
                    <thead class="table-dark">
                        <tr>
                            <th>ID</th>
                            <th>Cliente</th>
                            <th>Fecha</th>
                            <th>Estado</th>
                            <th>Total</th>
                            <th>Productos</th>
                            <th>Dirección</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for orden in ordenes %}
                        <tr class="orden-row" data-estado="{{ orden.estado }}" data-fecha="{{ orden.fecha.strftime('%Y-%m-%d') }}" data-cliente="{{ orden.usuario.nombre.lower() }}">
                            <td><strong>#{{ orden.id }}</strong></td>
                            <td>
                                <div>
                                    <strong>{{ orden.usuario.nombre }}</strong><br>
                                    <small class="text-muted">{{ orden.usuario.email }}</small><br>
                                    <small class="text-muted">{{ orden.usuario.celular or 'Sin teléfono' }}</small>
                                </div>
                            </td>
                            <td>
                                <small>{{ orden.fecha.strftime('%d/%m/%Y') }}</small><br>
                                <small class="text-muted">{{ orden.fecha.strftime('%H:%M') }}</small>
                            </td>
                            <td>
                                <span class="badge 
                                    {% if orden.estado == 'pendiente' %}bg-warning
                                    {% elif orden.estado == 'pagado' %}bg-success
                                    {% elif orden.estado == 'enviado' %}bg-info
                                    {% elif orden.estado == 'cancelado' %}bg-danger
                                    {% else %}bg-secondary{% endif %}">
                                    {{ orden.estado.title() }}
                                </span>
                            </td>
                            <td>
                                <strong>${{ "%.2f"|format(orden.total_final) }}</strong><br>
                                <small class="text-muted">{{ orden.metodo_pago or 'N/A' }}</small>
                            </td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary" type="button" data-bs-toggle="collapse" data-bs-target="#productos-{{ orden.id }}">
                                    <i class="fas fa-eye"></i> Ver ({{ orden.detalle|length }})
                                </button>
                                <div class="collapse mt-2" id="productos-{{ orden.id }}">
                                    <div class="card card-body">
                                        {% for detalle in orden.detalle %}
                                        <small>
                                            <strong>{{ detalle.producto.nombre }}</strong><br>
                                            Cantidad: {{ detalle.cantidad }} - ${{ "%.2f"|format(detalle.precio_unitario) }} c/u
                                        </small>
                                        {% if not loop.last %}<hr class="my-1">{% endif %}
                                        {% endfor %}
                                    </div>
                                </div>
                            </td>
                            <td>
                                <small>
                                    {{ orden.direccion_envio.direccion }}<br>
                                    {{ orden.direccion_envio.ciudad }}, {{ orden.direccion_envio.departamento }}<br>
                                    {{ orden.direccion_envio.pais }}
                                </small>
                            </td>
                            <td>
                                <div class="btn-group-vertical" role="group">
                                    {% if orden.estado == 'pagado' %}
                                    <button class="btn btn-sm btn-success" onclick="cambiarEstado({{ orden.id }}, 'enviado')">
                                        <i class="fas fa-shipping-fast"></i> Marcar Enviado
                                    </button>
                                    {% endif %}
                                    
                                    {% if orden.estado in ['pendiente', 'pagado'] %}
                                    <button class="btn btn-sm btn-danger" onclick="cambiarEstado({{ orden.id }}, 'cancelado')">
                                        <i class="fas fa-times"></i> Cancelar
                                    </button>
                                    {% endif %}
                                    
                                    <a href="/admin/ordenes/{{ orden.id }}/detalle" class="btn btn-sm btn-outline-info">
                                        <i class="fas fa-info-circle"></i> Detalle
                                    </a>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            {% if not ordenes %}
            <div class="text-center py-5">
                <i class="fas fa-shopping-cart fa-3x text-muted mb-3"></i>
                <h4 class="text-muted">No hay órdenes registradas</h4>
                <p class="text-muted">Las órdenes aparecerán aquí cuando los clientes realicen compras.</p>
            </div>
            {% endif %}
        </div>
    </section>

    {% include "partials/footer.html" %}


    <script src="/static/script.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function cambiarEstado(ordenId, nuevoEstado) {
            if (confirm(`¿Estás seguro de cambiar el estado de la orden #${ordenId} a "${nuevoEstado}"?`)) {
                fetch(`/admin/ordenes/${ordenId}/estado`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({estado: nuevoEstado})
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                    } else {
                        alert('Error al cambiar el estado: ' + (data.message || 'Error desconocido'));
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error al cambiar el estado');
                });
            }
        }


        // Variables globales para filtros de fecha
        let fechaDesdeActual = null;
        let fechaHastaActual = null;

        function filtrarOrdenes() {
            const filtroEstado = document.getElementById('filtroEstado').value.toLowerCase();
            const buscarCliente = document.getElementById('buscarCliente').value.toLowerCase();
            
            const filas = document.querySelectorAll('.orden-row');
            
            filas.forEach(fila => {
                const estado = fila.getAttribute('data-estado');
                const fechaOrden = new Date(fila.getAttribute('data-fecha'));
                const cliente = fila.getAttribute('data-cliente');
                
                let mostrar = true;
                
                // Filtro por estado
                if (filtroEstado && estado !== filtroEstado) {
                    mostrar = false;
                }
                
                // Filtro por rango de fechas
                if (fechaDesdeActual && fechaOrden < fechaDesdeActual) {
                    mostrar = false;
                }
                if (fechaHastaActual && fechaOrden > fechaHastaActual) {
                    mostrar = false;
                }
                
                // Filtro por cliente
                if (buscarCliente && !cliente.includes(buscarCliente)) {
                    mostrar = false;
                }
                
                fila.style.display = mostrar ? '' : 'none';
            });
        }

        function aplicarFiltroFecha(dias) {
            const hoy = new Date();
            const fechaDesde = new Date();
            fechaDesde.setDate(hoy.getDate() - dias);
            
            // Establecer fechas globales
            fechaDesdeActual = fechaDesde;
            fechaHastaActual = hoy;
            
            // Actualizar campos visuales
            document.getElementById('fechaDesde').value = formatearFecha(fechaDesde);
            document.getElementById('fechaHasta').value = formatearFecha(hoy);
            
            // Aplicar filtros
            filtrarOrdenes();
            
            // Resaltar botón activo
            document.querySelectorAll('.btn-outline-primary').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
        }

        function aplicarRangoPersonalizado() {
            const fechaDesdeInput = document.getElementById('fechaDesde').value;
            const fechaHastaInput = document.getElementById('fechaHasta').value;
            
            if (!fechaDesdeInput && !fechaHastaInput) {
                alert('Por favor selecciona al menos una fecha');
                return;
            }
            
            // Establecer fechas globales
            fechaDesdeActual = fechaDesdeInput ? new Date(fechaDesdeInput) : null;
            fechaHastaActual = fechaHastaInput ? new Date(fechaHastaInput) : null;
            
            // Si solo hay fecha hasta, ajustar al final del día
            if (fechaHastaActual) {
                fechaHastaActual.setHours(23, 59, 59, 999);
            }
            
            // Aplicar filtros
            filtrarOrdenes();
            
            // Quitar resaltado de botones predefinidos
            document.querySelectorAll('.btn-outline-primary').forEach(btn => {
                btn.classList.remove('active');
            });
        }

        function limpiarFiltroFecha() {
            // Limpiar fechas globales
            fechaDesdeActual = null;
            fechaHastaActual = null;
            
            // Limpiar campos
            document.getElementById('fechaDesde').value = '';
            document.getElementById('fechaHasta').value = '';
            
            // Quitar resaltado de botones
            document.querySelectorAll('.btn-outline-primary').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Aplicar filtros
            filtrarOrdenes();
        }

        function formatearFecha(fecha) {
            const año = fecha.getFullYear();
            const mes = String(fecha.getMonth() + 1).padStart(2, '0');
            const dia = String(fecha.getDate()).padStart(2, '0');
            return `${año}-${mes}-${dia}`;
        }
    </script>
</body>
</html>
