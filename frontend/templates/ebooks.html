<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/x-icon" href="/static/img/favicon.png">
    <title>Ebooks - Santolina</title>
    <link rel="stylesheet" href="/static/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>

{% include "partials/header.html" %}

<!-- Ebooks Header -->
<div class="ebooks-container">
    <div class="ebooks-header">
        <h1 class="ebooks-title">
            <i class="fas fa-book"></i>
            Ebooks
        </h1>
        <p class="ebooks-subtitle">Descarga y disfruta de nuestra colección de ebooks sobre bienestar y crecimiento personal</p>
    </div>
</div>

<div class="container-tienda">

    <!-- TOGGLE FILTROS (visible en móvil) -->
    <div class="filters-toggle">
        <button id="filters-toggle" type="button"><i class="fas fa-filter"></i> Filtro</button>
    </div>

    <!-- SIDEBAR DE CATEGORÍAS -->
    <aside class="sidebar" id="sidebar">
        <div class="categories-nav">
            <h3>Categorías</h3>
            
            <!-- Macro recursivo para mostrar categorías anidadas -->
            {% macro render_category(categoria, level=0) %}
                <div class="category-item" data-level="{{ level }}">
                    {% if categoria.subcategorias %}
                        <!-- Categoría con subcategorías - clickeable para expandir -->
                        <div class="category-header" data-category-id="{{ categoria.id }}">
                            <i class="fas fa-chevron-right category-toggle"></i>
                            <a href="/ebooks?categoria={{ categoria.id }}" class="category-link">
                                {{ categoria.nombre }}
                            </a>
                        </div>
                        <!-- Subcategorías ocultas inicialmente -->
                        <div class="subcategory-list collapsed" data-level="{{ level + 1 }}">
                            {% for subcategoria in categoria.subcategorias %}
                                {{ render_category(subcategoria, level + 1) }}
                            {% endfor %}
                        </div>
                    {% else %}
                        <!-- Categoría sin subcategorías -->
                        <a href="/ebooks?categoria={{ categoria.id }}" class="category-link" data-level="{{ level }}">
                            {{ categoria.nombre }}
                        </a>
                    {% endif %}
                </div>
            {% endmacro %}

            <!-- Categorías principales -->
            <div class="category-list">
                {% for categoria in categorias_principales %}
                    {{ render_category(categoria, 0) }}
                {% endfor %}
            </div>
            
            <!-- Mostrar todas las categorías si hay filtro activo -->
            {% if categoria_actual %}
                <div class="all-categories">
                    <a href="/ebooks" class="btn-clear-all">
                        <i class="fas fa-times"></i>
                        Ver todas las categorías
                    </a>
                </div>
            {% endif %}
        </div>
    </aside>

    <!-- FONDO CLICKABLE PARA CERRAR SIDEBAR EN MÓVIL -->
    <div id="sidebar-backdrop"></div>

    <!-- CONTENIDO PRINCIPAL -->
    <div class="main-content">

        <!-- BARRA DE BUSQUEDA (sobre el grid) -->
        <div class="search-bar">
            <form id="search-form">
                <div class="search-input-wrapper">
                    <input type="text" name="q" id="search-input" placeholder="Buscar ebooks..." value="{{ q }}">
                    <button type="submit" aria-label="Buscar"><i class="fas fa-search"></i></button>
                </div>
            </form>
        </div>

        <!-- FILTROS ACTIVOS -->
        {% if categoria_actual or q %}
        <div class="active-filters">
            <span class="filter-label">Filtrado por:</span>
            <div class="filter-tags">
                {% if q %}
                <div class="filter-tag">
                    <span class="filter-text">Búsqueda: "{{ q }}"</span>
                    <a href="/ebooks{% if categoria_actual %}?categoria={{ categoria_actual.id }}{% endif %}" class="filter-remove" title="Quitar filtro de búsqueda">
                        <i class="fas fa-times"></i>
                    </a>
                </div>
                {% endif %}
                
                {% if categoria_actual %}
                <div class="filter-tag">
                    <span class="filter-text">{{ categoria_actual.nombre }}</span>
                    <a href="/ebooks{% if q %}?q={{ q }}{% endif %}" class="filter-remove" title="Quitar filtro de categoría">
                        <i class="fas fa-times"></i>
                    </a>
                </div>
                {% endif %}
                
                {% if categoria_actual or q %}
                <a href="/ebooks" class="clear-all-filters">
                    <i class="fas fa-times-circle"></i>
                    Limpiar todos
                </a>
                {% endif %}
            </div>
        </div>
        {% endif %}

        <!-- GRID DE EBOOKS -->
        <div class="products-grid" id="ebooks-container">
            {% for ebook in ebooks %}
            <div class="product-card">
                <div class="product-media">
                    <img src="{{ ebook.imagen_portada if ebook.imagen_portada else '/static/img/default-ebook.png' }}" alt="{{ ebook.titulo }}">
                </div>
                <div class="product-info">
                    <h4 class="product-title">{{ ebook.titulo }}</h4>
                    <p class="product-desc">{{ ebook.descripcion[:100] if ebook.descripcion else 'Ebook digital' }}{% if ebook.descripcion and ebook.descripcion|length > 100 %}...{% endif %}</p>
                    <div class="product-bottom">
                        <span class="price">USD {{ "%.2f"|format(ebook.precio) }}</span>
                        <a href="/ebooks/{{ ebook.id }}" class="btn-view" aria-label="Ver {{ ebook.titulo }}">Ver ebook</a>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- PAGINACIÓN -->
        <div class="pagination">
            {% if page > 1 %}
                <a href="?{% if q %}q={{ q }}&{% endif %}{% if categoria_actual %}categoria={{ categoria_actual.id }}&{% endif %}page={{ page-1 }}">Anterior</a>
            {% endif %}
        
            <span>Página {{ page }} de {{ total_pages }}</span>
        
            {% if page < total_pages %}
                <a href="?{% if q %}q={{ q }}&{% endif %}{% if categoria_actual %}categoria={{ categoria_actual.id }}&{% endif %}page={{ page+1 }}">Siguiente</a>
            {% endif %}
        </div>

    </div>
</div>

<script>
    const searchInput = document.getElementById('search-input');
    const searchForm = document.getElementById('search-form');
    const ebooksContainer = document.getElementById('ebooks-container');
    const sidebar = document.getElementById('sidebar');
    const sidebarBackdrop = document.getElementById('sidebar-backdrop');
    const filtersToggleBtn = document.getElementById('filters-toggle');

    // Búsqueda solo con Enter o botón de búsqueda
    searchInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            performSearch();
        }
    });

    function performSearch() {
        const q = searchInput.value.trim();
        const currentUrl = new URL(window.location);
        
        if (q) {
            currentUrl.searchParams.set('q', q);
        } else {
            currentUrl.searchParams.delete('q');
        }
        
        // Mantener la categoría actual si existe
        window.location.href = currentUrl.toString();
    }

    if (searchForm) {
        searchForm.addEventListener('submit', (e) => {
            e.preventDefault();
            performSearch();
        });
    }
    
    // Toggle del sidebar de categorías (móvil)
    if (filtersToggleBtn) {
        filtersToggleBtn.addEventListener('click', () => {
            sidebar.classList.add('open');
            sidebarBackdrop.classList.add('open');
        });
    }

    if (sidebarBackdrop) {
        sidebarBackdrop.addEventListener('click', () => {
            sidebar.classList.remove('open');
            sidebarBackdrop.classList.remove('open');
        });
    }

    // Funcionalidad de categorías desplegables
    document.addEventListener('DOMContentLoaded', () => {
        // Toggle de categorías
        document.querySelectorAll('.category-toggle').forEach(toggle => {
            toggle.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                
                const categoryHeader = toggle.parentElement;
                const subcategoryList = categoryHeader.nextElementSibling;
                
                if (subcategoryList && subcategoryList.classList.contains('subcategory-list')) {
                    // Toggle collapsed class
                    subcategoryList.classList.toggle('collapsed');
                    
                    // Rotar el ícono
                    toggle.classList.toggle('fa-chevron-right');
                    toggle.classList.toggle('fa-chevron-down');
                }
            });
        });

        // Captura el click en product-card y lleva al link del botón de ver ebook
        document.querySelectorAll('.product-card').forEach(card => {
            card.addEventListener('click', (e) => {
                // No navegar si se hace click en un enlace o botón
                if (e.target.tagName === 'A' || e.target.tagName === 'BUTTON') return;
                
                const link = card.querySelector('.btn-view');
                if(link) window.location.href = link.href;
            });
        });
    });
    
</script>

<style>
/* Estilos para categorías desplegables */
.category-header {
    display: flex;
    align-items: center;
    cursor: pointer;
    padding: 8px 0;
}

.category-toggle {
    margin-right: 8px;
    transition: transform 0.2s ease;
    cursor: pointer;
    color: #666;
}

.category-toggle:hover {
    color: #333;
}

.subcategory-list {
    margin-left: 20px;
    overflow: hidden;
    transition: max-height 0.3s ease, opacity 0.3s ease;
    max-height: 500px;
    opacity: 1;
}

.subcategory-list.collapsed {
    max-height: 0;
    opacity: 0;
    margin-bottom: 0;
}

.category-item[data-level="1"] .category-link {
    padding-left: 10px;
    font-size: 0.9em;
    color: #666;
}

.category-item[data-level="1"] .category-link:hover {
    color: #333;
}

.category-item[data-level="2"] .category-link {
    padding-left: 20px;
    font-size: 0.85em;
    color: #777;
}

.category-item[data-level="2"] .category-link:hover {
    color: #444;
}

.category-item[data-level="3"] .category-link {
    padding-left: 30px;
    font-size: 0.8em;
    color: #888;
}

.category-item[data-level="3"] .category-link:hover {
    color: #555;
}

/* Estilos generales para niveles superiores */
.category-item[data-level] .category-link {
    display: block;
    padding: 4px 0;
    text-decoration: none;
    transition: color 0.2s ease;
}

.category-item[data-level] .category-header {
    margin: 2px 0;
}

/* Indentación progresiva para niveles múltiples */
.subcategory-list .subcategory-list {
    margin-left: 15px;
}

.category-header .category-link {
    flex: 1;
    text-decoration: none;
    color: inherit;
}

.category-header .category-link:hover {
    text-decoration: none;
}
</style>

<script src="/static/script.js"></script>

</body>
</html>
